name: Code Check

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  code-check:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository code
      - name: Checkout code
        uses: actions/checkout@v3

      # Fetch the email of the developer who pushed the commit
      - name: Get Commit Author Email
        id: get-email
        run: |
          email=$(git log -1 --pretty=format:'%ae')
          echo "COMMIT_AUTHOR_EMAIL=$email" >> $GITHUB_ENV
          echo "Commit Author Email: $email"

      # Install Node.js dependencies
      - name: Install ESLint, Stylelint, and HTMLHint
        run: npm install eslint stylelint htmlhint --save-dev

      # Fix Permissions for Linters
      - name: Fix Permissions for Linters
        run: chmod +x ./node_modules/.bin/eslint ./node_modules/.bin/stylelint ./node_modules/.bin/htmlhint

      # Run ESLint for JavaScript/TypeScript
      - name: Run ESLint
        id: lint-js
        run: |
          echo "Running ESLint..."
          npx eslint "**/*.{js,jsx,ts,tsx}" --ignore-pattern "vendor/**" --ignore-pattern "eslint.config.js" --format stylish | tee eslint_output.txt || true

      # Run Stylelint for CSS
      - name: Run Stylelint
        id: lint-css
        run: |
          echo "Running Stylelint..."
          npx stylelint "**/*.css" --formatter json > stylelint_output.json || true

      # Run HTMLHint
      - name: Run HTMLHint
        id: lint-html
        run: |
          echo "Running HTMLHint..."
          npx htmlhint "**/*.html" --ignore "vendor/**" | tee htmlhint_output.txt || true

      # Set up PHP for Laravel Pint & PHPUnit
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.4
          extensions: json, dom, curl, libxml, mbstring, sqlite3, pdo, pdo_sqlite
          coverage: none

      # Install Composer Dependencies
      - name: Install Dependencies
        run: composer install --no-progress --prefer-dist --optimize-autoloader

      # Setup SQLite Database for Testing
      - name: Setup Test Database
        run: |
          touch database/database.sqlite
          php artisan migrate --env=testing --force

      # Install Laravel Pint
      - name: Install Pint
        run: composer global require laravel/pint

      # Add Composer Global Bin to Path
      - name: Add Composer Global Bin to Path
        run: echo "$HOME/.composer/vendor/bin" >> $GITHUB_PATH

      # Run Laravel Pint
      - name: Run Laravel Pint
        id: lint-php
        run: pint --test | tee pint_output.txt || true

      # Run PHPUnit Tests
      - name: Run PHPUnit Tests
        id: phpunit
        run: php artisan test --testsuite=Feature --testsuite=Unit | tee phpunit_output.txt || true

      # Commit and Push Changes (Laravel Pint Fixes)
      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Apply Pint fixes"
          branch: ${{ github.ref }}

      # Send Email Notification if Errors are Found
      - name: Send Email Notification
        if: failure()
        run: |
          echo "Sending email notification for errors..."
          sudo apt-get install msmtp -y

          # Configure msmtp
          echo "account default" > ~/.msmtprc
          echo "host smtp.gmail.com" >> ~/.msmtprc
          echo "port 587" >> ~/.msmtprc
          echo "auth on" >> ~/.msmtprc
          echo "user ${{ secrets.SMTP_USER }}" >> ~/.msmtprc
          echo "password ${{ secrets.SMTP_PASSWORD }}" >> ~/.msmtprc
          echo "from ${{ env.COMMIT_AUTHOR_EMAIL }}" >> ~/.msmtprc
          echo "tls on" >> ~/.msmtprc
          echo "logfile ~/.msmtp.log" >> ~/.msmtprc
          chmod 600 ~/.msmtprc

          # Prepare email content
          message="Subject: Code Check - Linting & Test Report\n\n"

          message+="ğŸ”¥ Laravel CI Report ğŸ”¥\n\n"

          if grep -q "ERROR" eslint_output.txt; then
            message+="ğŸ›‘ JavaScript Errors:\n$(cat eslint_output.txt | sed 's/^/ - /')\n\n"
          fi

          if grep -q "ERROR" stylelint_output.json; then
            message+="ğŸ¨ CSS Errors:\n$(jq . stylelint_output.json)\n\n"
          fi

          if grep -q "ERROR" htmlhint_output.txt; then
            message+="ğŸ“„ HTML Errors:\n$(cat htmlhint_output.txt)\n\n"
          fi

          if grep -q "ERROR" pint_output.txt; then
            message+="ğŸ˜ PHP Code Style Issues:\n$(cat pint_output.txt)\n\n"
          fi

          if grep -q "FAILURES" phpunit_output.txt; then
            message+="âš¡ PHPUnit Test Failures:\n$(cat phpunit_output.txt)\n\n"
          fi

          printf "$message" | msmtp ${{ secrets.RECIPIENT_EMAIL }}
